331. Средняя сетевая задержка

    средняяsqlfirst_2023_backend

В одном из сервисов организована древовидная структура бэкендов. Запросы в сервис обрабатываются следующим образом: в корневой бэкенд (назовем его balancer.test.yandex.ru) поступает запрос, он формирует подзапросы в бэкенды-потомки (не более одного подзапроса в потомок), ожидает от них ответ, формирует свой ответ и отправляет его пользователю. Каждый из потомков обрабатывает подзапросы по той же схеме. На всех бэкендах регистрируются события следующей структуры:

    datetime — время наступления события;

    request_id — id запроса;

    parent_request_id — id родительского запроса (для корневого бэкенда NULL);

    host — имя бэкенда, на котором возникло событие;

    type — тип события (список указан ниже);

    data — описание события.

События бывают следующих типов:

    RequestReceived — на бэкенд поступил новый запрос (поле data пустое);

    RequestSent — на бэкенд-потомок был отправлен подзапрос (в поле data записывается имя бэкенда-потомка);

    ResponseSent — бэкенд отправил ответ родителю (data пустое);

    ResponseReceived — бэкенд получил ответ от потомка (в поле data записываются имя бэкенда-потомка и статус — OK или ERROR — , разделенные символом табуляции).

Все события собираются в одну таблицу. Очевидно, что на каждом бэкенде имеются сетевые издержки на пересылку запросов и ответов. Для одного запроса в корневой бэкенд считаем, что на них тратится сумма разниц datetime между всеми соответствующими парами событий RequestSent/RequestReceived и ResponseSent/ResponseReceived, которые возникли при обработке запроса. Вам нужно посчитать эту величину, усредненную по запросам в корневой бэкенд.
Формат ввода

Используется БД postgresql 10.6.1 x64.

Система перед проверкой создает таблицу с событиями следующим запросом:

CREATE TABLE requests (
datetime TIMESTAMP,
request_id UUID,
parent_request_id UUID,
host TEXT,
type TEXT,
data TEXT
);

После таблица заполняется тестовыми данными.
Формат вывода

Напишите SELECT выражение, которое вернет таблицу из одной строки с колонкой avg_network_time_ms типа numeric, в которую будет записана средняя сетевая задержка в миллисекундах.

Внимание! Текст выражения подставится в систему как подзапрос, поэтому завершать выражение точкой с запятой не надо (в противном случае вы получите ошибку Presentation Error).

[Решение](solution.sql)
